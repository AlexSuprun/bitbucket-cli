name: Changeset Check

on:
  pull_request:
    branches: [main]

jobs:
  check:
    name: Check for changeset
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changesets
        id: changesets
        run: |
          # Count only changesets added in this PR, not pre-existing ones
          NEW_CHANGESETS=$(git diff --name-only origin/main...HEAD | grep '\.changeset/.*\.md$' | grep -v README.md | wc -l | tr -d ' ')
          echo "count=$NEW_CHANGESETS" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/main...HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check if only docs/config files changed
          DOCS_ONLY=true
          for file in $FILES; do
            case "$file" in
              *.md|.github/*|docs/*|.changeset/*)
                ;;
              *)
                DOCS_ONLY=false
                break
                ;;
            esac
          done
          echo "docs_only=$DOCS_ONLY" >> $GITHUB_OUTPUT

      - name: Require changeset
        if: steps.changesets.outputs.count == '0' && steps.changed.outputs.docs_only == 'false'
        run: |
          echo "::error::Missing changeset. Please run 'bun changeset' and commit the generated file."
          echo ""
          echo "Changesets are required for PRs that modify source code."
          echo "See CONTRIBUTING.md for details."
          echo ""
          echo "Changed files:"
          echo "${{ steps.changed.outputs.files }}"
          exit 1

      - name: Changeset found
        if: steps.changesets.outputs.count != '0'
        run: |
          echo "New changeset found in this PR! Ready for review."

      - name: Docs-only change
        if: steps.changesets.outputs.count == '0' && steps.changed.outputs.docs_only == 'true'
        run: |
          echo "Docs/config-only change detected. Changeset not required."
